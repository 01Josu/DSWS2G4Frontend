<!-- Formulario de incidencia -->
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8 mb-4">
      <div class="card shadow">
        <div class="card-header text-white bg-dark">
          <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Registrar Incidencia</h4>
        </div>
        <div class="card-body p-4">
          <form [formGroup]="incidenciaForm" (ngSubmit)="registrarIncidencia()" novalidate>
            <!-- Mensajes de éxito o error -->
            <div *ngIf="mensajeExito" class="alert alert-success py-2 mb-3">
              <i class="bi bi-check-circle-fill me-2"></i>{{ mensajeExito }}
            </div>
            <div *ngIf="mensajeError" class="alert alert-danger py-2 mb-3">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ mensajeError }}
            </div>

            <!-- Correo electrónico - Primera Fila -->
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Correo electrónico</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-envelope"></i>
                  </span>
                  <input
                    type="email"
                    class="form-control form-control-lg"
                    placeholder="Ingrese su correo"
                    formControlName="correo"
                    [ngClass]="{'is-invalid': incidenciaForm.get('correo')?.invalid && incidenciaForm.get('correo')?.touched}">
                  <div *ngIf="buscandoUsuario" class="input-group-text">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Buscando...</span>
                    </div>
                  </div>
                </div>
                <div class="invalid-feedback" *ngIf="incidenciaForm.get('correo')?.invalid && incidenciaForm.get('correo')?.touched">
                  Ingrese un correo electrónico válido
                </div>
              </div>
            </div>

            <!-- Información del usuario encontrado -->
            <div *ngIf="usuarioEncontrado" class="row mb-3">
              <div class="col-12">
                <div class="alert alert-success">
                  <h6 class="alert-heading">
                    <i class="bi bi-check-circle-fill me-2"></i>Usuario encontrado
                  </h6>
                  <p class="mb-1"><strong>Correo:</strong> {{ usuarioEncontrado.correoNumero }}</p>
                  <p class="mb-1"><strong>Equipo asignado:</strong> {{ usuarioEncontrado.equipo?.codigoEquipo }}</p>
                  <p class="mb-0"><strong>Tipo:</strong> {{ usuarioEncontrado.equipo?.tipo }} - {{ usuarioEncontrado.equipo?.marca }}</p>
                </div>
              </div>
            </div>

            <!-- Selección de Categoría -->
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Categoría del problema</label>
                <select
                  class="form-select form-select-lg"
                  formControlName="categoriaId"
                  [ngClass]="{'is-invalid': incidenciaForm.get('categoriaId')?.invalid && incidenciaForm.get('categoriaId')?.touched}">
                  <option value="">
                    <span *ngIf="cargandoCategorias">Cargando categorías...</span>
                    <span *ngIf="!cargandoCategorias">Seleccione una categoría</span>
                  </option>
                  <option *ngFor="let categoria of categorias" [value]="categoria.id">
                    {{ categoria.nombre }}
                  </option>
                </select>
                <div class="invalid-feedback">
                  Seleccione una categoría
                </div>
              </div>
            </div>

            <!-- Selección de Subcategoría -->
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Subcategoría</label>
                <select
                  class="form-select form-select-lg"
                  formControlName="subcategoriaId"
                  [disabled]="!incidenciaForm.get('categoriaId')?.value"
                  [ngClass]="{'is-invalid': incidenciaForm.get('subcategoriaId')?.invalid && incidenciaForm.get('subcategoriaId')?.touched}">
                  <option value="">
                    <span *ngIf="cargandoSubcategorias">Cargando subcategorías...</span>
                    <span *ngIf="!cargandoSubcategorias && !incidenciaForm.get('categoriaId')?.value">Primero seleccione una categoría</span>
                    <span *ngIf="!cargandoSubcategorias && incidenciaForm.get('categoriaId')?.value">Seleccione una subcategoría</span>
                  </option>
                  <option *ngFor="let subcategoria of subcategorias" [value]="subcategoria.id">
                    {{ subcategoria.nombre }}
                  </option>
                </select>
                <div class="invalid-feedback">
                  Seleccione una subcategoría
                </div>
              </div>
            </div>

            <!-- Selección de Problema -->
            <div class="row mb-4">
              <div class="col-12">
                <label class="form-label">Descripción específica del problema</label>
                <select
                  class="form-select form-select-lg"
                  formControlName="problemaId"
                  [disabled]="!incidenciaForm.get('subcategoriaId')?.value"
                  [ngClass]="{'is-invalid': incidenciaForm.get('problemaId')?.invalid && incidenciaForm.get('problemaId')?.touched}">
                  <option value="">
                    <span *ngIf="cargandoProblemas">Cargando problemas...</span>
                    <span *ngIf="!cargandoProblemas && !incidenciaForm.get('subcategoriaId')?.value">Primero seleccione una subcategoría</span>
                    <span *ngIf="!cargandoProblemas && incidenciaForm.get('subcategoriaId')?.value">Seleccione el problema específico</span>
                  </option>
                  <option *ngFor="let problema of problemas" [value]="problema.id">
                    {{ problema.descripcion }}
                  </option>
                </select>
                <div class="invalid-feedback">
                  Seleccione un problema específico
                </div>
              </div>
            </div>

            <!-- Botón de envío -->
            <div class="d-grid">
              <button
                type="submit"
                class="btn btn-dark btn-lg"
                [disabled]="incidenciaForm.invalid || !usuarioEncontrado">
                <i class="bi bi-send-fill me-2"></i>Registrar Incidencia
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="flex-grow-1"></div>
